// Generated by CoffeeScript 2.3.2
(function() {
  window.SubmarineCable = {};
  var indexOf = [].indexOf;

  SubmarineCable.Map = (function() {
    class Map {  
      clearLandingPointLabels() {
        if (this.lpLabels && this.lpLabels.length) {
          this.lpLabels.forEach(box => box.close());
        }
        this.lpLabels = [];
      }
      
      renderLandingPointLabels(desc = []) {
        this.lpLabels = this.lpLabels || [];
        const mkContent = (name) =>
        `<div class="lp-label" style="background: rgba(255,255,255,0.9);border: 1px solid #ccc;border-radius: 4px;padding: 2px 6px;font-size: 12px;color: #404040;white-space: nowrap;">
           ${name}
        </div>`;
        for (const d of desc) {
          const [lat, lon] = String(d.latlon).split(',');
          const latLng = new google.maps.LatLng(parseFloat(lat), parseFloat(lon));
          const name = d.name || d.landing_point || d.slug || '';
          const box = new InfoBox({
            closeBoxURL: "",
            alignBottom: true,
            pixelOffset: new google.maps.Size(-20, -25),
            content: mkContent(name),
            position: latLng
          });
          box.open(this.gmap);
          this.lpLabels.push(box);
        }
      }

      landingIcon() {
        return { 
          path: google.maps.SymbolPath.CIRCLE,
          scale: 6,
          fillColor: '#ffffff',
          fillOpacity: 1.0,
          strokeColor: '#404040',
          strokeOpacity: 1.0,
          strokeWeight: 1.5
        };
      }

      showCables() {
        this.cables = new google.maps.Data({
          map: this.gmap
        });
        this.cables.loadGeoJson(SubmarineCable.Map.cablesGeoJSON);
        return this.cables.setStyle((feature) => {
          return {
            strokeColor: `#${feature.getProperty("color")}`,
            strokeWeight: 2
          };
        });
      }
      
      cableStrokeStyle(feature) {
        const slug = feature.getProperty("slug");
        const color = `#${feature.getProperty("color")}`;
        const isSelected = this.selectedIds && this.selectedIds.indexOf(slug) >= 0;
        return {
          strokeColor: color, 
          strokeOpacity: isSelected ? 1.0 : 0.2,
          strokeWeight: isSelected ? 3 : 2
        };
      }

 
      
      refreshStyles() {
        if (this.cables) {
          this.cables.setStyle((feature) => this.cableStrokeStyle(feature));
        }
        if (this.landings && this._lastDescForLandings) {
          const ids = (this._lastDescForLandings || []).map(d => d.landing_point_id);
          this.landings.setStyle((feature) => {
            const visible = ids.indexOf(feature.getProperty("id")) >= 0;
            return { icon: this.landingIcon(), visible };
          });
          this.clearLandingPointLabels();
          this.renderLandingPointLabels(this._lastDescForLandings);
        }
      }

      showLandingPoints() {
        this.landings = new google.maps.Data({
          map: this.gmap
        });
        this.landings.loadGeoJson(SubmarineCable.Map.landingsGeoJSON);
        return this.landings.setStyle({
          icon: this.landingIcon()
        });
      }

      
      selectCable(ids, desc, is_map_clicked = false) {
        this.infoBox.close();
        this._lastDescForLandings = desc;
        this.selectedIds = Array.isArray(ids) ? ids.slice() : (ids ? [ids] : []);

        this.cables.setStyle((feature) => {
          const slug = feature.getProperty("slug");
          const color = `#${feature.getProperty("color")}`;
          const isSelected = this.selectedIds.includes(slug);
          return {
            strokeColor: color,
            strokeOpacity: isSelected ? 1.0 : 0.2,
            strokeWeight: isSelected ? 3 : 2
          };
        });

        this.landings.setStyle((feature) => {
          var d, ref;
          if (ref = feature.getProperty("id"), indexOf.call((function() {
            var i, len, results;
            results = [];
            for (i = 0, len = desc.length; i < len; i++) {
              d = desc[i];
              results.push(d.landing_point_id);
            }
            return results;
          })(), ref) >= 0) {
            return { icon: this.landingIcon() };
          } else {
            return { icon: this.landingIcon(), visible: false };
          }
        });
        this.clearLandingPointLabels();
        this.renderLandingPointLabels(desc);
        
        return this.boundMap(desc);
      }

      selectCountry(cables, landing_points, latlons) {
        this.infoBox.close();
        this.cables.setStyle((feature) => {
          var d, ref;
          if (ref = feature.getProperty("slug"), indexOf.call((function() {
            var i, len, results;
            results = [];
            for (i = 0, len = cables.length; i < len; i++) {
              d = cables[i];
              results.push(d.id);
            }
            return results;
          })(), ref) >= 0) {
            return {
              strokeColor: `#${feature.getProperty("color")}`,
              strokeOpacity: 1
            };
          } else {
            return {
              strokeColor: `#${feature.getProperty("color")}`,
              strokeOpacity: 0.1
            };
          }
        });
        this.landings.setStyle((feature) => {
          var d, ref;
          const visibleIds = (function() {
            var i, len, results;
            results = [];
            for (i = 0, len = desc.length; i < len; i++) {
              d = desc[i];
              results.push(d.landing_point_id);
            }
            return results;
          })();

          if (ref = feature.getProperty("id"), indexOf.call(visibleIds, ref) >= 0) {
            return { icon: this.landingIcon(), visible: true };
          } else {
            return { icon: this.landingIcon(), visible: false };
          }
        });
        return this.boundMap(desc);
      }

      selectRfs(data) {
        this.infoBox.close();
        this.cables.setStyle((feature) => {
          var d, ref;
          if (ref = feature.getProperty("slug"), indexOf.call((function() {
            var i, len, ref1, results;
            ref1 = data.cables;
            results = [];
            for (i = 0, len = ref1.length; i < len; i++) {
              d = ref1[i];
              results.push(d.id);
            }
            return results;
          })(), ref) >= 0) {
            return {
              strokeColor: `#${feature.getProperty("color")}`,
              strokeOpacity: 1
            };
          } else {
            return {
              strokeColor: `#${feature.getProperty("color")}`,
              strokeOpacity: 0.1
            };
          }
        });

        return this.landings.setStyle((feature) => {
          var d, ref;
          if (ref = feature.getProperty("id"), indexOf.call((function() {
            var i, len, ref1, results;
            ref1 = data.landing_points;
            results = [];
            for (i = 0, len = ref1.length; i < len; i++) {
              d = ref1[i];
              results.push(d.landing_point_id);
            }
            return results;
          })(), ref) >= 0) {
            return {
              icon: this.landingIcon()
            };
          } else {
            return {
              icon: this.landingIcon(),
              visible: false
            };
          }
        });
      }

      boundMap(desc) {
        var bounds, i, len, value;
        bounds = new google.maps.LatLngBounds();
        for (i = 0, len = desc.length; i < len; i++) {
          value = desc[i];
          bounds.extend(new google.maps.LatLng(value.latlon.split(',')[0], value.latlon.split(',')[1]));
        }
        this.gmap.fitBounds(bounds);
        if (this.gmap.getZoom() > 5) {
          return this.gmap.setZoom(this.gmap.getZoom() - 2);
        }
      }

      selectLandingPoint(name, latLng) {
        this.cables.setStyle((feature) => {
          return {
            strokeColor: `#${feature.getProperty("color")}`,
            strokeOpacity: 1
          };
        });
        this.landings.setStyle((feature) => {
          return {
            icon: this.landingIcon()
          };
        });
        this.infoBox.close();
        this.gmap.panTo(latLng);
        this.infoBox.setContent(`<div class="infoBoxContent"><div class="infoBoxPointer"></div>${name}</div>`);
        this.infoBox.setPosition(latLng);
        return this.infoBox.open(this.gmap);
      }

      resetMap() {
        this.selectedIds = [];
        this.clearLandingPointLabels();
        this.cables.setStyle((feature) => {
          return {
            strokeColor: `#${feature.getProperty("color")}`,
            strokeOpacity: 1
          };
        });
        this.landings.setStyle((feature) => {
          return {
            icon: this.landingIcon()
          };
        });
        return this.infoBox.close();
      }

      resetBounds() {
        this.gmap.setZoom(2);
        return this.gmap.setCenter(new google.maps.LatLng(30.0, -30.0));
      }
      
      setEvents() {
        google.maps.event.addListener(this.gmap, 'click', (event) => {
          return jQuery(location).attr('href', "#/");
        });

        this.cables.addListener('click', async (event) => {
          const slug = event.feature.getProperty('slug');
          const nativeEvt = event.domEvent || event.originalEvent || {};
          const isMulti = nativeEvt.metaKey || nativeEvt.ctrlKey;

          if (isMulti) {
            const set = new Set(this.selectedIds || []);
            if (set.has(slug)) set.delete(slug); else set.add(slug);
            const ids = Array.from(set);
            this.selectedIds = ids;

            const mergedDesc = await this.mergeLandingDescForCables(ids);

            this.selectCable(ids, mergedDesc);
            return;
          }

          const ids = [slug];
          const mergedDesc = await this.mergeLandingDescForCables(ids);
          this.selectCable(ids, mergedDesc);
          return;
        });

        this.landings.addListener('click', (event) => {
          const lpSlug = event.feature.getProperty('slug');
          return jQuery(location).attr('href', `#/landing-point/${lpSlug}`);
        });
      }

      isMobile() {
        var error;
        try {
          return window.matchMedia("only screen and (max-width:736px)").matches;
        } catch (error1) {
          error = error1;
          return false;
        }
      }

      analytics(category, action, label) {}

      // _gaq.push(['_trackEvent', category, action, label]) if _gaq
      constructor(element, config) {
        this.element = element;
        this.config = config;
        this.creation_time = this.config.creation_time;
        this.gmap = new google.maps.Map(document.getElementById(this.element), {
          zoom: this.isMobile() ? 1 : 3,
          maxZoom: 8,
          minZoom: 2,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          styles: SubmarineCable.Map.mapStyles,
          center: new google.maps.LatLng(30.0, -30.0),
          streetViewControl: false,
          mapTypeControl: false,
          zoomControlOptions: {
            position: google.maps.ControlPosition.TOP_LEFT
          },
          disableDefaultUI: this.isMobile() ? true : false
        });
        this.infoBox = new InfoBox({
          closeBoxURL: "",
          alignBottom: true,
          pixelOffset: new google.maps.Size(-60, -15)
        });
        this.showCables();
        this.showLandingPoints();
        this.setEvents();
        this.selectedIds = [];
        this.lpLabels = [];
        return this;
      }

    };

    Map.cablesGeoJSON = "/api/v2/cable/cable-geo.json";

    Map.landingsGeoJSON = "/api/v2/landing-point/landing-point-geo.json";

    Map.mapStyles = [
      {
        "featureType": "landscape",
        "stylers": [
          {
            "visibility": "on"
          },
          {
            "color": "#d9d9d9"
          }
        ]
      },
      {
        "featureType": "poi",
        "stylers": [
          {
            "visibility": "off"
          }
        ]
      },
      {
        "featureType": "road",
        "stylers": [
          {
            "visibility": "off"
          }
        ]
      },
      {
        "featureType": "transit",
        "stylers": [
          {
            "visibility": "off"
          }
        ]
      },
      {
        "featureType": "administrative.locality",
        "stylers": [
          {
            "visibility": "off"
          }
        ]
      },
      {
        "featureType": "administrative.neighborhood",
        "stylers": [
          {
            "visibility": "off"
          }
        ]
      },
      {
        "featureType": "administrative.land_parcel",
        "stylers": [
          {
            "visibility": "off"
          }
        ]
      },
      {
        "featureType": "administrative.country",
        "elementType": "labels.text.fill",
        "stylers": [
          {
            "color": "#000000"
          },
          {
            "visibility": "on"
          }
        ]
      },
      {
        "featureType": "administrative.province",
        "stylers": [
          {
            "visibility": "off"
          }
        ]
      },
      {
        "featureType": "water",
        "elementType": "geometry.fill",
        "stylers": [
          {
            "color": "#ffffff"
          },
          {
            "visibility": "on"
          }
        ]
      },
      {
        "elementType": "labels.text.fill",
        "stylers": [
          {
            "color": "#808080"
          }
        ]
      }
    ];

    return Map;

  }).call(this);

}).call(this);
